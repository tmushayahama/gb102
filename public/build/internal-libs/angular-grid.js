!function(angular,window,undefined){"use strict";function imageLoaded(img){return img.complete&&("undefined"==typeof img.naturalWidth||0!==img.naturalWidth)}function domToAry(list){return Array.prototype.slice.call(list)}var defaults={gridWidth:300,gutterSize:10,gridNo:"auto",direction:"ltor",refreshOnImgLoad:!0,cssGrid:!1,performantScroll:!1,pageSize:"auto",scrollContainer:"body",infiniteScrollDelay:3e3,infiniteScrollDistance:100},$=angular.element,camelCaseToHyphenCase=function(str){return str.replace(/([a-z])([A-Z])/g,"$1-$2").toLowerCase()},cloneCss={visibility:"hidden",opacity:0,top:0,left:0,width:""},single=function(){var $elm=$(window);return function(elm){return $elm[0]=elm,$elm}}();$(document.head).append("<style>.ag-no-transition{-webkit-transition: none !important;transition: none !important;} .angular-grid{position : relative;} .angular-grid > *{opacity : 0} .angular-grid > .angular-grid-item{opacity : 1}</style>"),angular.module("angularGrid",[]).directive("angularGrid",["$timeout","$window","$q","angularGridInstance",function($timeout,$window,$q,angularGridInstance){return{restrict:"A",scope:{model:"=angularGrid",dep_gridWidth:"=gridWidth",dep_gutterSize:"=gutterSize",dep_refreshOnImgLoad:"=refreshOnImgLoad",dep_direction:"=direction",dep_cssGrid:"=cssGrid",dep_options:"=angularGridOptions",dep_gridNo:"=gridNo",dep_agId:"@angularGridId",gridNo:"=agGridNo",gridWidth:"=agGridWidth",gutterSize:"=agGutterSize",refreshOnImgLoad:"=agRefreshOnImgLoad",direction:"=agDirection",cssGrid:"=agCssGrid",options:"=agOptions",agId:"@",pageSize:"=agPageSize",performantScroll:"=agPerformantScroll",scrollContainer:"=agScrollContainer",infiniteScroll:"&agInfiniteScroll",infiniteScrollDistance:"=agInfiniteScrollDistance",infiniteScrollDelay:"=agInfiniteScrollDelay"},link:function(scope,element,attrs){function getOptions(){options={},Object.keys(defaults).forEach(function(key){scope[key]!==undefined?options[key]=scope[key]:scope["dep_"+key]!==undefined&&(options[key]=scope["dep_"+key])}),options=angular.extend({},defaults,options,scope.options||scope.dep_options),options.cssGrid&&(options.gutterSize=0),"auto"==options.pageSize&&(options.pageSize=window.offsetWidth>=768?2:3)}function findPos(obj,withRespectTo){withRespectTo=withRespectTo||document.body;var curleft=0,curtop=0;if(obj.offsetParent)do curleft+=obj.offsetLeft,curtop+=obj.offsetTop,obj=obj.offsetParent;while(obj&&obj!=withRespectTo);return{left:curleft,top:curtop}}function getScrollContainerInfo(){var container=$(document.querySelector(options.scrollContainer)),contElm=container[0];return{height:contElm.offsetHeight,scrollHeight:contElm.scrollHeight,startFrom:findPos(domElm,contElm).top,$elm:"body"==options.scrollContainer?win:container}}function calculatePageInfo(listElmPosInfo,scrollBodyHeight,colNo){scrollNs.pageInfo=[{from:0}];var elmInfo,from,to,pageSize=options.pageSize,scrollContHeight=scrollNs.scrollContInfo.height,pageHeight=scrollContHeight*pageSize,totalPages=Math.ceil(scrollBodyHeight/pageHeight),pageNo=0;for(pageNo=0;totalPages>pageNo;pageNo++)for(var idx=0,ln=listElmPosInfo.length;ln>idx;idx++)if(elmInfo=listElmPosInfo[idx],from=pageNo?pageHeight*pageNo:0,to=pageHeight*(pageNo+1),elmInfo.bottom<from||elmInfo.top>to){if(elmInfo.top>to)break}else scrollNs.pageInfo[pageNo]||(scrollNs.pageInfo[pageNo]={from:idx}),scrollNs.pageInfo[pageNo].to=idx;scrollNs.pageInfo=scrollNs.pageInfo.map(function(page,idx){var fromPage=Math.max(idx-1,0),toPage=Math.min(idx+1,scrollNs.pageInfo.length-1);return{from:scrollNs.pageInfo[fromPage].from,to:scrollNs.pageInfo[toPage].to}})}function bindWatchersOnVisible(visibleELm){var itemData,$item,i,ln;for(i=0,ln=listElms.length;ln>i;i++)$item=single(listElms[i]),itemData=$item.data(),itemData.$scope&&($item.data("_agOldWatchers",itemData.$scope.$$watchers),itemData.$scope.$$watchers=[]);for(i=0,ln=visibleELm.length;ln>i;i++)itemData=single(visibleELm[i]).data(),itemData.$scope&&(itemData.$scope.$$watchers=itemData._agOldWatchers||[],itemData.$scope.$digest())}function refreshDomElm(scrollTop){scrollNs.lastScrollPosition=scrollTop;var filteredElm;if(!scrollNs.isBusy){var currentPage=0,pageSize=options.pageSize;if(scrollTop>scrollNs.scrollContInfo.startFrom+scrollNs.scrollContInfo.height*pageSize&&(currentPage=Math.floor((scrollTop-scrollNs.scrollContInfo.startFrom)/(scrollNs.scrollContInfo.height*pageSize))),currentPage!=scrollNs.lastPage){scrollNs.lastPage=currentPage;var curPageInfo=scrollNs.pageInfo[currentPage];curPageInfo&&(element.children().detach(),filteredElm=Array.prototype.slice.call(listElms,curPageInfo.from,curPageInfo.to+1),bindWatchersOnVisible(filteredElm),element.append(filteredElm))}}}function reEnableInfiniteScroll(){clearTimeout(scrollNs.infiniteScrollTimeout),scrollNs.isLoading=!1}function infiniteScroll(scrollTop){if(!scrollNs.isLoading&&scope.model.length){var scrollHeight=scrollNs.scrollContInfo.scrollHeight,contHeight=scrollNs.scrollContInfo.height;scrollTop>=scrollHeight-contHeight*(1+options.infiniteScrollDistance/100)&&(scrollNs.isLoading=!0,scope.infiniteScroll(),scrollNs.infiniteScrollTimeout=setTimeout(reEnableInfiniteScroll,options.infiniteScrollDelay))}}function scrollHandler(){var scrollTop=this.scrollTop||this.scrollY;options.performantScroll&&refreshDomElm(scrollTop),scope.infiniteScroll&&infiniteScroll(scrollTop)}function getColWidth(){var clone,contWidth=domElm.offsetWidth;if(options.cssGrid){clone=$(listElms[0]).clone(),clone.css(cloneCss).addClass("ag-no-transition ag-clone"),element.append(clone);var width=clone[0].offsetWidth;return clone.remove(),{no:Math.floor((contWidth+12)/width),width:width}}var colWidth="auto"==options.gridNo?options.gridWidth:Math.floor(contWidth/options.gridNo)-options.gutterSize,cols="auto"==options.gridNo?Math.floor((contWidth+options.gutterSize)/(colWidth+options.gutterSize)):options.gridNo,remainingSpace=(contWidth+options.gutterSize)%(colWidth+options.gutterSize);return colWidth+=Math.floor(remainingSpace/cols),{no:cols,width:colWidth}}function afterImageLoad(container,options){var beforeLoad=options.beforeLoad||angular.noop,onLoad=options.onLoad||angular.noop,isLoaded=options.isLoaded||angular.noop,onFullLoad=options.onFullLoad||angular.noop,ignoreCheck=options.ignoreCheck||angular.noop,allImg=container.find("img"),loadedImgPromises=[];domToAry(allImg).forEach(function(img){img.src&&(beforeLoad(img),imageLoaded(img)||ignoreCheck(img)?isLoaded(img):loadedImgPromises.push($q(function(resolve,reject){img.onload=function(){onLoad(img),resolve()},img.onerror=reject})))}),loadedImgPromises.length?$q.all(loadedImgPromises).then(onFullLoad,onFullLoad):setTimeout(function(){onFullLoad()},0)}function reflowGrids(){reflowCount++;var i,colInfo=getColWidth(),colWidth=colInfo.width,cols=colInfo.no,lastRowBottom=[];for(i=0;cols>i;i++)lastRowBottom.push(0);domToAry(listElms).forEach(function(item){var $item=single(item);domToAry($item.find("img")).forEach(function(img){var $img=$(img);if($img.hasClass("img-loaded"))return void $img.css("height","");$item.addClass("ag-no-transition"),$item.css("width",colWidth+"px");var actualWidth=$img.attr("actual-width")||$img.attr("data-actual-width"),actualHeight=$img.attr("actual-height")||$img.attr("data-actual-height");actualWidth&&actualHeight&&$img.css("height",actualHeight*img.width/actualWidth+"px")}),$item.removeClass("ag-no-transition")});var clones=listElms.clone();clones.addClass("ag-no-transition ag-clone");var clonesCssObj=angular.extend({},cloneCss);clonesCssObj.width=colWidth+"px",clones.css(clonesCssObj),element.append(clones),function(reflowIndx){afterImageLoad(clones,{ignoreCheck:function(img){return!single(img).hasClass("img-loaded")},onFullLoad:function(){if(!(reflowCount>reflowIndx)){var item,i,ln,listElmHeights=[],listElmPosInfo=[];for(i=0,ln=clones.length;ln>i;i++)listElmHeights.push(clones[i].offsetHeight);for(i=0,ln=listElms.length;ln>i;i++){item=single(listElms[i]);var height=listElmHeights[i],top=Math.min.apply(Math,lastRowBottom),col=lastRowBottom.indexOf(top);lastRowBottom[col]=top+height+options.gutterSize;var posX=col*(colWidth+options.gutterSize),cssObj={position:"absolute",top:top+"px"};"rtol"==options.direction?cssObj.right=posX+"px":cssObj.left=posX+"px",cssObj.width=colWidth+"px",listElmPosInfo.push({top:top,bottom:top+height}),item.css(cssObj).addClass("angular-grid-item")}var contHeight=Math.max.apply(Math,lastRowBottom);element.css("height",contHeight+"px"),clones.remove(),(options.performantScroll||scope.infiniteScroll)&&(scrollNs.scrollContInfo=getScrollContainerInfo()),options.performantScroll&&(scrollNs.lastPage=null,calculatePageInfo(listElmPosInfo,contHeight,cols),scrollNs.isBusy=!1,refreshDomElm(scrollNs.lastScrollPosition||0)),reEnableInfiniteScroll()}}})}(reflowCount)}function handleImage(){var reflowPending=!1;domToAry(listElms).forEach(function(listItem){var $listItem=$(listItem),allImg=$listItem.find("img");allImg.length&&($listItem.addClass("img-loading"),afterImageLoad($listItem,{beforeLoad:function(img){single(img).addClass("img-loading")},isLoaded:function(img){single(img).removeClass("img-loading").addClass("img-loaded")},onLoad:function(img){!reflowPending&&options.refreshOnImgLoad&&(reflowPending=!0,$timeout(function(){reflowGrids(),reflowPending=!1},100)),single(img).removeClass("img-loading").addClass("img-loaded")},onFullLoad:function(){$listItem.removeClass("img-loading").addClass("img-loaded")}}))})}function getListElms(){return $(domToAry(element.children()).filter(function(elm){return!single(elm).hasClass("ag-clone")}))}function ngCheckAnim(){var leavingElm=domToAry(listElms).filter(function(elm){return single(elm).hasClass("ng-leave")});return $q(function(resolve){leavingElm.length?single(leavingElm[0]).one("webkitTransitionEnd transitionend msTransitionEnd oTransitionEnd",function(){$timeout(function(){listElms=getListElms(),resolve()})}):resolve()})}function watch(){scrollNs.isBusy=!0,$timeout(function(){listElms=getListElms(),ngCheckAnim().then(function(){handleImage(),$timeout(function(){reflowGrids()})})})}function watchOptions(){getOptions(),listElms&&reflowGrids()}function windowResizeCallback(){scrollNs.isBusy=!0;var contWidth=domElm.offsetWidth;lastDomWidth!=contWidth&&(lastDomWidth=contWidth,timeoutPromise&&$timeout.cancel(timeoutPromise),timeoutPromise=$timeout(function(){options.performantScroll&&(element.children().detach(),element.append(listElms)),reflowGrids()},100))}var listElms,timeoutPromise,domElm=element[0],win=$($window),agId=scope.agId||scope.dep_agId,reflowCount=0;element.addClass("angular-grid");var options;["gridWidth","gutterSize","refreshOnImgLoad","direction","options","cssGrid","gridNo","agId"].forEach(function(key){var depKey=camelCaseToHyphenCase(key),correctKey="ag-"+camelCaseToHyphenCase(key);"options"==key&&(depKey="angular-grid-options"),"agId"==key&&(depKey="angular-grid-id",correctKey="ag-id"),scope["dep_"+key]!==undefined&&console&&console.warn&&console.warn(depKey+" is deprecated. Use "+correctKey+" instead in template.")}),getOptions();var scrollNs={};setTimeout(function(){scrollNs.scrollContInfo=getScrollContainerInfo(),scrollNs.scrollContInfo.$elm.on("scroll",scrollHandler)},0),scope.$watch("model",watch,!0),scope.$watch("options",watchOptions,!0),Object.keys(defaults).forEach(function(key){scope[key]!==undefined&&scope.$watch(key,watchOptions)});var lastDomWidth=domElm.offsetWidth;win.on("resize",windowResizeCallback),agId&&(angularGridInstance[agId]={refresh:function(){watch()},handleScroll:function(scrollTop){options.performantScroll&&refreshDomElm(scrollTop),scope.infiniteScroll&&infiniteScroll(scrollTop)}}),scope.$on("$destroy",function(){agId&&delete angularGridInstance[agId],win.off("resize",windowResizeCallback),clearTimeout(scrollNs.infiniteScrollTimeout),scrollNs.scrollContInfo&&scrollNs.scrollContInfo.$elm.off("scroll",scrollHandler)})}}}]).factory("angularGridInstance",function(){var angularGridInstance={};return angularGridInstance})}(angular,window);